> 渡一

文件需要hash
hash算法可用md5实现
md5的库有spark-md5

file调用slice即可得到blob对象
File 和 Blob对象只记录文件的信息，没有资源的内容
要得到内容要使用FileReader去读取
### 实现
```typescript
fileInput.onchange = async function () {
  const file = this.files[0]
  // 使用
  const chunks = createChunks(file, 10 * 1024 * 1024)
  console.log("chunks: ", chunks)
  const fileHash = await hash(chunks) // 得到file的hash值
  console.log("fileHash: ", fileHash)
}
function createChunks(file, chunkSize) {
  const result = []
  for (let i = 0; i < file.size; i += chunkSize) {
    result.push(file.slice(i, i + chunkSize))
  }
  return result
}
// 增量算法
// 算hash 因为一个文件太大，cpu内存吃不消，通过调用spark.append一片片去算
function hash(chunks) {
  return new Promise((resolve, reject) => {
    const spark = new SparkMD5() // spark-md5库
    function _read(i) {
      if (i >= chunks.length) {
        resolve(spark.end()) // 返回hash值
        return
      }
      const blob = chunks[i]
      const reader = new FileReader()
      reader.onload = e => {
        const bytes = e.target.result
        spark.append(bytes)
        _read(i + 1)
      }
      reader.readAsArrayBuffer(blob)
    }
    _read(0)
  })
}
```
### web-worker
由于耗时，可以放到web worker里进行处理
```typescript
function getHashByWorker(chunkList) {
  return new Promise(resolve => {
    const worker = new Worker("./hash.js")
    worker.postMessage({ chunkList })
    worker.onmessage = e => {
      const { hash } = e.data
      if (hash) {
        resolve(hash)
      }
    }
  })
}

// hash.js
self.importScripts("./spark-md5.min.js")
self.onmessage = e => {
    const { chunkList } = e.data
    hash(chunkList).then(res => {
        self.postMessage({
            hash: res,
        })
    })
}

function hash(chunks) {
    return new Promise((resolve, reject) => {
        const spark = new SparkMD5() // spark-md5库
        function _read(i) {
            if (i >= chunks.length) {
                resolve(spark.end()) // 返回hash值
                return
            }
            const blob = chunks[i]
            const reader = new FileReader()
            reader.onload = e => {
                const bytes = e.target.result
                spark.append(bytes)
                _read(i + 1)
            }
            reader.readAsArrayBuffer(blob)
        }
        _read(0)
    })
}

```
目录结构![image.png](https://cdn.nlark.com/yuque/0/2023/png/28823371/1677308034217-7bf17286-6edb-4595-b3f2-08f3ae7c35c9.png#averageHue=%232b2c2e&clientId=u40264de2-1c09-4&from=paste&height=85&id=u95c5b6df&originHeight=106&originWidth=271&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=5652&status=done&style=none&taskId=uc3f50186-5b50-42dd-9996-98fbdafbfcf&title=&width=216.8)
